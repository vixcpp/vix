<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Vix Security Demo — CORS + CSRF + Headers</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
      }
      button {
        padding: 10px 14px;
        margin: 6px 8px 6px 0;
        cursor: pointer;
      }
      code {
        background: #f3f3f3;
        padding: 2px 6px;
        border-radius: 6px;
      }
      pre {
        background: #0b0b0b;
        color: #eaeaea;
        padding: 14px;
        border-radius: 10px;
        overflow: auto;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
      }
      .hint {
        color: #444;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <h1>CORS + CSRF + Security Headers (Vix.cpp)</h1>

    <p class="hint">
      Server: <code>http://localhost:8080</code> (must be running)<br />
      This page should be served from another origin (ex:
      <code>http://localhost:5173</code>).
    </p>

    <div class="row">
      <button id="btnCsrf">→ GET /api/csrf</button>
      <button id="btnPostMissing">
        → POST /api/update (missing CSRF header)
      </button>
      <button id="btnPostOk">→ POST /api/update (correct CSRF header)</button>
      <button id="btnPreflight">→ OPTIONS /api/update (preflight)</button>
    </div>

    <pre id="out">Ready.</pre>

    <script>
      const API = "http://localhost:8080";
      let csrfToken = null;

      const out = document.getElementById("out");
      const log = (x) =>
        (out.textContent =
          typeof x === "string" ? x : JSON.stringify(x, null, 2));

      async function show(res) {
        const text = await res.text().catch(() => "");
        const headers = {};
        res.headers.forEach((v, k) => (headers[k] = v));
        return { ok: res.ok, status: res.status, headers, body: text };
      }

      document.getElementById("btnCsrf").onclick = async () => {
        try {
          const res = await fetch(`${API}/api/csrf`, {
            method: "GET",
            credentials: "include",
          });

          const meta = await show(res);

          let parsed = null;
          try {
            parsed = JSON.parse(meta.body);
          } catch {}

          csrfToken = parsed?.csrf_token ?? parsed?.["csrf_token"] ?? null;
          meta.saved_csrf_token = csrfToken;

          log(meta);
        } catch (e) {
          log(String(e));
        }
      };

      document.getElementById("btnPostMissing").onclick = async () => {
        try {
          const res = await fetch(`${API}/api/update`, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "x=1",
          });
          log(await show(res));
        } catch (e) {
          log(String(e));
        }
      };

      document.getElementById("btnPostOk").onclick = async () => {
        try {
          if (!csrfToken)
            return log("Missing csrfToken. Click GET /api/csrf first.");

          const res = await fetch(`${API}/api/update`, {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRF-Token": csrfToken,
            },
            body: "x=1",
          });

          const meta = await show(res);

          if (meta.status === 403 && meta.body.includes("csrf_failed")) {
            meta.hint =
              "Browser likely did NOT send csrf_token cookie (SameSite=Lax blocks cross-site POST). " +
              "Serve frontend from same origin OR use SameSite=None; Secure on HTTPS.";
          }

          log(meta);
        } catch (e) {
          log(String(e));
        }
      };

      document.getElementById("btnPreflight").onclick = async () => {
        try {
          const res = await fetch(`${API}/api/update`, {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRF-Token": "preflight-demo",
            },
            body: "x=1",
          });

          const meta = await show(res);
          meta.note =
            "Open DevTools → Network. You'll see an automatic OPTIONS preflight before this POST.";
          log(meta);
        } catch (e) {
          log(String(e));
        }
      };
    </script>
  </body>
</html>
